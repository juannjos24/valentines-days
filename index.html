<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>San Valentín</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Dancing+Script:wght@500;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --r1:#6B0000; --r2:#B02020; --r3:#E05050; --r4:#F08080;
  --bg:#FFF0F2;
}

html, body {
  width:100%; height:100%; overflow:hidden;
  background:var(--bg);
  font-family:'Playfair Display',serif;
  -webkit-tap-highlight-color:transparent;
  user-select:none;
}

/* ── Fondo ── */
.bg {
  position:fixed; inset:0; z-index:0;
  background:
    radial-gradient(ellipse 70% 60% at 20% 80%, #ffe0e5 0%, transparent 60%),
    radial-gradient(ellipse 50% 40% at 80% 20%, #ffd6dc 0%, transparent 55%),
    radial-gradient(ellipse 100% 100% at 50% 50%, #fff5f6 0%, #ffeaed 100%);
}

/* ── Escenas ── */
.scene {
  position:fixed; inset:0; z-index:1;
  display:flex; align-items:center; justify-content:center;
  opacity:0; pointer-events:none;
  transition:opacity 0.7s ease;
}
.scene.active { opacity:1; pointer-events:all; }

/* ── Escena 1 ── */
#s1 { flex-direction:column; gap:clamp(12px,3vw,24px); }

.hint {
  font-family:'Dancing Script',cursive;
  font-size:clamp(1rem,4vw,1.5rem);
  color:var(--r2); opacity:0;
  animation:fadeUp 1s 0.8s forwards;
}
@keyframes fadeUp {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}

#heart-btn {
  background:none; border:none; cursor:pointer; padding:0; outline:none;
  filter:drop-shadow(0 8px 28px rgba(176,32,32,0.4));
  animation:beat 1.5s ease-in-out infinite;
  touch-action:manipulation;
}
#heart-btn:active { transform:scale(0.88)!important; animation:none!important; }
@keyframes beat {
  0%,100% { transform:scale(1); }
  15%     { transform:scale(1.12); }
  30%     { transform:scale(1); }
  45%     { transform:scale(1.08); }
}

/* ── Escena 2 ── */
#drop-heart { position:absolute; }

/* ── Escena 3 ── */
#s3 { align-items:flex-end; }
#tree-wrap {
  width:min(420px,94vw); height:100vh;
  position:relative;
}
#tree-svg {
  width:100%; height:100%;
  position:absolute; bottom:0;
  overflow:visible;
}

/* ── Escena 4 ── */
#s4 { align-items:flex-end; justify-content:flex-start; }
#s4-inner { width:100%; height:100%; position:relative; }

#tree-right {
  position:absolute; right:0; bottom:0;
  width:min(310px,55vw); height:100vh;
  transform:translateX(108%);
  transition:transform 1.4s cubic-bezier(0.16,1,0.3,1);
}
#tree-right.in { transform:translateX(0); }
#tree-right svg { width:100%; height:100%; overflow:visible; }

/* ── Contador ── */
#counter {
  position:absolute;
  left:clamp(16px,5vw,50px); top:50%;
  transform:translateY(-50%);
  opacity:0; transition:opacity 1s 1.4s;
}
#counter.in { opacity:1; }

.c-label {
  font-family:'Dancing Script',cursive;
  font-size:clamp(0.85rem,3vw,1.1rem);
  color:var(--r2); display:block; margin-bottom:5px;
}
.c-name {
  font-family:'Dancing Script',cursive;
  font-size:clamp(1.5rem,6.5vw,2.3rem);
  color:var(--r1); display:block; line-height:1.1;
  margin-bottom:clamp(10px,3vw,20px);
}
.c-row { display:flex; gap:clamp(8px,2.5vw,16px); }
.c-unit { text-align:center; }
.c-val {
  display:block;
  font-family:'Playfair Display',serif; font-weight:700;
  font-size:clamp(1.9rem,7.5vw,2.8rem); color:var(--r1);
  line-height:1; min-width:2ch;
}
.c-lbl {
  font-family:'Dancing Script',cursive;
  font-size:clamp(0.6rem,2.2vw,0.8rem); color:var(--r2);
}

/* ── Hojas cayendo ── */
.fl {
  position:fixed; pointer-events:none; z-index:20;
  will-change:transform,opacity;
  animation:fall linear forwards;
}
@keyframes fall {
  0%   { transform:translate(0,0) rotate(0deg); opacity:1; }
  80%  { opacity:0.9; }
  100% { transform:translate(var(--dx),var(--dy)) rotate(var(--dr)); opacity:0; }
}

/* ── Restart ── */
#restart {
  position:fixed; bottom:clamp(16px,4vw,28px); right:clamp(16px,4vw,28px);
  z-index:50; background:var(--r2); color:#fff;
  border:none; border-radius:50px;
  padding:clamp(8px,2vw,12px) clamp(18px,4vw,26px);
  font-family:'Dancing Script',cursive;
  font-size:clamp(0.9rem,3.5vw,1.1rem);
  cursor:pointer; opacity:0; pointer-events:none;
  transition:opacity 0.5s, transform 0.15s;
  box-shadow:0 4px 18px rgba(176,32,32,0.3);
  touch-action:manipulation;
}
#restart.in { opacity:1; pointer-events:all; }
#restart:active { transform:scale(0.94); }

/* ── Línea suelo ── */
#ground {
  position:fixed; bottom:28%; left:0; right:0; height:2px; z-index:5;
  background:linear-gradient(90deg,transparent,var(--r4) 30%,var(--r2) 50%,var(--r4) 70%,transparent);
  opacity:0; transform:scaleX(0); transform-origin:center;
  transition:opacity 0.3s, transform 0.5s cubic-bezier(0.2,0.8,0.4,1);
}
</style>
</head>
<body>
<div class="bg"></div>
<div id="ground"></div>

<!-- ══════════ ESCENA 1: CORAZÓN ══════════ -->
<div class="scene active" id="s1">
  <p class="hint">Toca el corazón ♥</p>
  <button id="heart-btn" aria-label="Corazón San Valentín">
    <svg style="width:clamp(110px,28vw,145px);height:auto" viewBox="0 0 140 130" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="hg" cx="38%" cy="28%" r="72%">
          <stop offset="0%"   stop-color="#FF6B6B"/>
          <stop offset="45%"  stop-color="#C0392B"/>
          <stop offset="100%" stop-color="#7B0000"/>
        </radialGradient>
        <filter id="hf" x="-20%" y="-20%" width="140%" height="140%">
          <feGaussianBlur stdDeviation="3" result="b"/>
          <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <path d="M70 118C70 118 8 76 8 38C8 19 23 6 42 6C53 6 63 12 70 22C77 12 87 6 98 6C117 6 132 19 132 38C132 76 70 118 70 118Z"
            fill="url(#hg)" filter="url(#hf)"/>
      <ellipse cx="48" cy="34" rx="17" ry="11" fill="rgba(255,255,255,0.28)" transform="rotate(-28 48 34)"/>
      <ellipse cx="38" cy="26" rx="7"  ry="5"  fill="rgba(255,255,255,0.18)" transform="rotate(-28 38 26)"/>
      <line x1="22" y1="16" x2="30" y2="10" stroke="rgba(255,210,210,0.8)" stroke-width="2"   stroke-linecap="round"/>
      <line x1="16" y1="28" x2="10" y2="24" stroke="rgba(255,210,210,0.7)" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="25" y1="10" x2="20"  y2="4" stroke="rgba(255,210,210,0.6)" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
  </button>
</div>

<!-- ══════════ ESCENA 2: CAÍDA ══════════ -->
<div class="scene" id="s2">
  <svg id="drop-heart" style="width:clamp(70px,20vw,100px)" viewBox="0 0 140 130" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="hg2" cx="38%" cy="28%" r="72%">
        <stop offset="0%"   stop-color="#FF6B6B"/>
        <stop offset="45%"  stop-color="#C0392B"/>
        <stop offset="100%" stop-color="#7B0000"/>
      </radialGradient>
    </defs>
    <path d="M70 118C70 118 8 76 8 38C8 19 23 6 42 6C53 6 63 12 70 22C77 12 87 6 98 6C117 6 132 19 132 38C132 76 70 118 70 118Z"
          fill="url(#hg2)"/>
    <ellipse cx="48" cy="34" rx="17" ry="11" fill="rgba(255,255,255,0.25)" transform="rotate(-28 48 34)"/>
  </svg>
</div>

<!-- ══════════ ESCENA 3: ÁRBOL ══════════ -->
<div class="scene" id="s3">
  <div id="tree-wrap">
    <svg id="tree-svg" viewBox="0 0 420 730" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="tG" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%"   stop-color="#2E1505"/>
          <stop offset="35%"  stop-color="#5A3010"/>
          <stop offset="68%"  stop-color="#8B5A2B"/>
          <stop offset="100%" stop-color="#3A1F05"/>
        </linearGradient>
      </defs>

      <!-- Tronco, 3 capas -->
      <path class="T" d="M218 730C216 690 214 645 212 592C210 540 208 487 207 438C206 393 205 353 204 313C203 276 202 246 200 215"
            stroke="#1E0C02" stroke-width="22" fill="none" stroke-linecap="round" style="stroke-dasharray:700;stroke-dashoffset:700"/>
      <path class="T" d="M210 730C208 690 206 645 204 592C202 540 200 487 199 438C198 393 197 353 196 313C195 276 194 246 192 215"
            stroke="url(#tG)" stroke-width="32" fill="none" stroke-linecap="round" style="stroke-dasharray:700;stroke-dashoffset:700"/>
      <path class="T" d="M203 730C202 690 200 645 199 592C198 540 197 487 196 438C195 393 195 353 194 313C193 276 192 246 191 215"
            stroke="#8B5A2B" stroke-width="9" fill="none" stroke-linecap="round" opacity="0.38" style="stroke-dasharray:700;stroke-dashoffset:700"/>
      <!-- Raíces -->
      <path class="T" d="M208 730C196 722 176 728 160 726" stroke="#2E1505" stroke-width="11" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="T" d="M212 730C224 722 244 728 260 726" stroke="#2E1505" stroke-width="9"  fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>

      <!-- Ramas nivel 1 -->
      <path class="B" d="M207 585C188 565 162 546 130 528C108 514 84 503 58 492" stroke="#4A2A0A" stroke-width="18" fill="none" stroke-linecap="round" style="stroke-dasharray:220;stroke-dashoffset:220"/>
      <path class="B" d="M211 573C230 553 256 536 282 520C304 507 328 497 354 487" stroke="#4A2A0A" stroke-width="18" fill="none" stroke-linecap="round" style="stroke-dasharray:220;stroke-dashoffset:220"/>
      <!-- Ramas nivel 2 -->
      <path class="B" d="M205 497C185 478 158 459 126 443C104 429 80 419 52 409" stroke="#5A3010" stroke-width="13" fill="none" stroke-linecap="round" style="stroke-dasharray:200;stroke-dashoffset:200"/>
      <path class="B" d="M209 486C227 467 252 450 276 435C298 421 322 411 348 403" stroke="#5A3010" stroke-width="13" fill="none" stroke-linecap="round" style="stroke-dasharray:200;stroke-dashoffset:200"/>
      <!-- Ramas nivel 3 -->
      <path class="B" d="M202 413C183 392 156 371 126 355C104 341 78 329 50 319" stroke="#6B3F15" stroke-width="10" fill="none" stroke-linecap="round" style="stroke-dasharray:200;stroke-dashoffset:200"/>
      <path class="B" d="M207 402C224 381 248 361 271 345C293 330 317 319 343 309" stroke="#6B3F15" stroke-width="10" fill="none" stroke-linecap="round" style="stroke-dasharray:200;stroke-dashoffset:200"/>
      <!-- Rama central -->
      <path class="B" d="M203 355C201 333 199 308 197 280C195 254 193 232 191 208" stroke="#5A3010" stroke-width="12" fill="none" stroke-linecap="round" style="stroke-dasharray:200;stroke-dashoffset:200"/>
      <!-- Sub-ramas izquierda -->
      <path class="B" d="M58 492C42 476 24 460 8 444"   stroke="#6B3F15" stroke-width="8" fill="none" stroke-linecap="round" style="stroke-dasharray:100;stroke-dashoffset:100"/>
      <path class="B" d="M58 492C66 474 80 459 97 448"  stroke="#6B3F15" stroke-width="8" fill="none" stroke-linecap="round" style="stroke-dasharray:100;stroke-dashoffset:100"/>
      <path class="B" d="M52 409C36 391 18 375 2 359"   stroke="#7B4F22" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M52 409C62 391 77 376 95 366"  stroke="#7B4F22" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M50 319C34 301 16 284 2 268"   stroke="#8B5F2A" stroke-width="4" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M50 319C62 302 78 286 97 276"  stroke="#8B5F2A" stroke-width="4" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <!-- Sub-ramas derecha -->
      <path class="B" d="M354 487C369 471 385 456 400 442" stroke="#6B3F15" stroke-width="8" fill="none" stroke-linecap="round" style="stroke-dasharray:100;stroke-dashoffset:100"/>
      <path class="B" d="M354 487C344 469 330 455 312 444" stroke="#6B3F15" stroke-width="8" fill="none" stroke-linecap="round" style="stroke-dasharray:100;stroke-dashoffset:100"/>
      <path class="B" d="M348 403C363 386 380 370 396 355" stroke="#7B4F22" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M348 403C336 386 320 371 302 361" stroke="#7B4F22" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M343 309C358 292 374 276 390 261" stroke="#8B5F2A" stroke-width="4" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M343 309C330 292 314 277 296 267" stroke="#8B5F2A" stroke-width="4" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <!-- Cima -->
      <path class="B" d="M191 208C185 190 177 170 171 148C165 128 161 108 159 86" stroke="#6B3F15" stroke-width="8" fill="none" stroke-linecap="round" style="stroke-dasharray:160;stroke-dashoffset:160"/>
      <path class="B" d="M191 208C202 191 215 173 225 156" stroke="#7B4F22" stroke-width="4" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M191 208C179 191 165 173 154 156" stroke="#7B4F22" stroke-width="4" fill="none" stroke-linecap="round" style="stroke-dasharray:80;stroke-dashoffset:80"/>
      <path class="B" d="M159 86C153 68 148 50 146 32"    stroke="#8B5F2A" stroke-width="4" fill="none" stroke-linecap="round" style="stroke-dasharray:70;stroke-dashoffset:70"/>
      <path class="B" d="M159 86C167 69 177 52 185 36"    stroke="#9B6F3A" stroke-width="3" fill="none" stroke-linecap="round" style="stroke-dasharray:60;stroke-dashoffset:60"/>
      <path class="B" d="M159 86C150 69 139 52 129 36"    stroke="#9B6F3A" stroke-width="3" fill="none" stroke-linecap="round" style="stroke-dasharray:60;stroke-dashoffset:60"/>

      <!-- Hojas generadas por JS -->
      <g id="leaves-s3" opacity="0"></g>
    </svg>
  </div>
</div>

<!-- ══════════ ESCENA 4: CONTADOR + ÁRBOL ══════════ -->
<div class="scene" id="s4">
  <div id="s4-inner">

    <div id="tree-right">
      <svg viewBox="0 0 320 720" xmlns="http://www.w3.org/2000/svg" overflow="visible">
        <defs>
          <linearGradient id="tG4" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%"   stop-color="#2E1505"/>
            <stop offset="35%"  stop-color="#5A3010"/>
            <stop offset="68%"  stop-color="#8B5A2B"/>
            <stop offset="100%" stop-color="#3A1F05"/>
          </linearGradient>
        </defs>
        <!-- Tronco -->
        <path d="M168 720C166 680 164 636 162 583C160 531 158 479 157 432C156 388 155 350 154 312C153 276 152 246 150 215"
              stroke="#1E0C02" stroke-width="18" fill="none" stroke-linecap="round"/>
        <path d="M160 720C158 680 156 636 154 583C152 531 150 479 149 432C148 388 147 350 146 312C145 276 144 246 142 215"
              stroke="url(#tG4)" stroke-width="26" fill="none" stroke-linecap="round"/>
        <path d="M153 720C152 680 151 636 150 583C149 531 149 479 148 432C147 388 147 350 146 312C145 276 145 246 144 215"
              stroke="#8B5A2B" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.36"/>
        <!-- Raíces -->
        <path d="M158 720C148 713 132 718 118 716" stroke="#2E1505" stroke-width="9"  fill="none" stroke-linecap="round"/>
        <path d="M162 720C172 713 188 718 202 716" stroke="#2E1505" stroke-width="8"  fill="none" stroke-linecap="round"/>
        <!-- Nivel 1 -->
        <path d="M157 573C140 554 117 537 90 521C71 509 50 499 28 490"    stroke="#4A2A0A" stroke-width="14" fill="none" stroke-linecap="round"/>
        <path d="M161 562C178 543 202 527 224 513C244 500 266 491 290 483" stroke="#4A2A0A" stroke-width="14" fill="none" stroke-linecap="round"/>
        <!-- Nivel 2 -->
        <path d="M154 488C138 469 114 451 86 437C67 425 45 415 22 407"    stroke="#5A3010" stroke-width="10" fill="none" stroke-linecap="round"/>
        <path d="M158 478C175 459 198 443 218 429C238 416 260 407 284 399" stroke="#5A3010" stroke-width="10" fill="none" stroke-linecap="round"/>
        <!-- Nivel 3 -->
        <path d="M151 406C135 386 111 366 83 352C63 340 40 329 16 321"    stroke="#6B3F15" stroke-width="7"  fill="none" stroke-linecap="round"/>
        <path d="M155 396C171 376 193 357 213 343C233 329 255 319 279 311" stroke="#6B3F15" stroke-width="7"  fill="none" stroke-linecap="round"/>
        <!-- Central -->
        <path d="M151 350C149 328 147 303 145 276C143 250 141 228 139 205" stroke="#5A3010" stroke-width="9"  fill="none" stroke-linecap="round"/>
        <!-- Sub-ramas izq -->
        <path d="M28 490C14 475 0 461 -12 447"    stroke="#6B3F15" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M28 490C36 473 50 459 65 449"    stroke="#6B3F15" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M22 407C8 390 -6 374 -18 359"    stroke="#7B4F22" stroke-width="5" fill="none" stroke-linecap="round"/>
        <path d="M16 321C4 304 -8 288 -18 272"    stroke="#8B5F2A" stroke-width="3" fill="none" stroke-linecap="round"/>
        <!-- Sub-ramas der -->
        <path d="M290 483C303 468 316 454 328 441" stroke="#6B3F15" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M284 399C296 383 310 368 322 354" stroke="#7B4F22" stroke-width="5" fill="none" stroke-linecap="round"/>
        <path d="M279 311C291 294 305 278 315 262" stroke="#8B5F2A" stroke-width="3" fill="none" stroke-linecap="round"/>
        <!-- Cima -->
        <path d="M139 205C133 187 126 167 121 146C116 126 113 106 111 84" stroke="#6B3F15" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M139 205C149 188 160 170 168 153" stroke="#7B4F22" stroke-width="3" fill="none" stroke-linecap="round"/>
        <path d="M139 205C128 188 116 170 106 153" stroke="#7B4F22" stroke-width="3" fill="none" stroke-linecap="round"/>
        <path d="M111 84C106 66 102 48 100 30"     stroke="#8B5F2A" stroke-width="3" fill="none" stroke-linecap="round"/>
        <path d="M111 84C118 67 126 50 132 34"     stroke="#9B6F3A" stroke-width="2" fill="none" stroke-linecap="round"/>
        <path d="M111 84C103 67 93 50 85 34"       stroke="#9B6F3A" stroke-width="2" fill="none" stroke-linecap="round"/>
        <!-- Hojas por JS -->
        <g id="leaves-s4"></g>
      </svg>
    </div>

    <!-- Contador -->
    <div id="counter">
      <span class="c-label">Mi amor por ti comenzó hace…</span>
      <span class="c-name" id="c-name">Para ti ♥</span>
      <div class="c-row">
        <div class="c-unit"><span class="c-val" id="cd">--</span><span class="c-lbl">días</span></div>
        <div class="c-unit"><span class="c-val" id="ch">--</span><span class="c-lbl">horas</span></div>
        <div class="c-unit"><span class="c-val" id="cm">--</span><span class="c-lbl">minutos</span></div>
        <div class="c-unit"><span class="c-val" id="cs">--</span><span class="c-lbl">segundos</span></div>
      </div>
    </div>

  </div>
</div>

<button id="restart" onclick="App.init()">↺ Repetir</button>

<script>
// ═══════════════════════════════════════════
//  CONFIGURACIÓN  ← cambia aquí
// ═══════════════════════════════════════════
const CFG = {
  loveDate: new Date('2024-02-14T00:00:00'),
  loveName: 'Para ti ♥',
};
// ═══════════════════════════════════════════

const SVGNS = 'http://www.w3.org/2000/svg';
const el    = id => document.getElementById(id);

/* ── utilidades ── */
const wait = ms => new Promise(r => setTimeout(r, ms));
const rnd  = (a,b) => a + Math.random()*(b-a);
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

/* ── Gestor de timers ── */
const T = {
  _: [],
  to(fn,ms) { const t=setTimeout(fn,ms);  this._.push({t,iv:0}); return t; },
  iv(fn,ms) { const t=setInterval(fn,ms); this._.push({t,iv:1}); return t; },
  clear() { this._.forEach(({t,iv}) => iv?clearInterval(t):clearTimeout(t)); this._=[]; },
};

/* ── Hojas DOM (cayendo) ── */
const Floaters = { clear() { document.querySelectorAll('.fl').forEach(x=>x.remove()); } };

// ═══════════════════════════════════════════
//  HOJAS EN RAMAS (Bézier)
// ═══════════════════════════════════════════

const HEART  = "M10 17C10 17 0.5 10.5 0.5 5.2C0.5 2.3 2.8 0 5.8 0C7.5 0 9 0.85 10 2.1C11 0.85 12.5 0 14.2 0C17.2 0 19.5 2.3 19.5 5.2C19.5 10.5 10 17 10 17Z";
const COLORS = ['#6B0000','#8B1010','#A82020','#C03030','#D84848','#B02020'];

/* Punto en curva cúbica de Bézier */
function bez(p0,p1,p2,p3,t){
  const u=1-t;
  return { x:u*u*u*p0.x+3*u*u*t*p1.x+3*u*t*t*p2.x+t*t*t*p3.x,
           y:u*u*u*p0.y+3*u*u*t*p1.y+3*u*t*t*p2.y+t*t*t*p3.y };
}
/* Punto en segmento */
function seg(p0,p1,t){ return { x:p0.x+(p1.x-p0.x)*t, y:p0.y+(p1.y-p0.y)*t }; }

/*
  Planta n hojas a lo largo de pts (bezier 4 pts, o segmento 2 pts).
  sp: dispersión perpendicular. side: -1 izq | 1 der | 0 ambos.
*/
function plantLeaves(group, pts, n, szMin, szMax, sp, side=0){
  const cubic = pts.length===4;
  for(let i=0; i<n; i++){
    const t  = rnd(0.06,0.94);
    const pt = cubic ? bez(...pts,t) : seg(pts[0],pts[1],t);
    // Tangente → normal
    const dt  = 0.01, t2=Math.min(t+dt,1);
    const pt2 = cubic ? bez(...pts,t2) : seg(pts[0],pts[1],t2);
    const tx=pt2.x-pt.x, ty=pt2.y-pt.y, L=Math.hypot(tx,ty)||1;
    const nx=-ty/L, ny=tx/L;
    // Posición
    const s  = side===0 ? (Math.random()<0.5?1:-1) : side;
    const fx = pt.x + nx*s*rnd(3,sp) + rnd(-2,2);
    const fy = pt.y + ny*s*rnd(3,sp) + rnd(-2,2);
    // Tamaño y rotación
    const sz  = rnd(szMin,szMax);
    const rot = rnd(-40,40)+s*rnd(0,14);
    // SVG element
    const g = document.createElementNS(SVGNS,'g');
    g.setAttribute('transform',
      `translate(${fx-sz},${fy-sz*0.9}) rotate(${rot},${sz},${sz*0.9})`);
    const p = document.createElementNS(SVGNS,'path');
    p.setAttribute('d', HEART);
    p.setAttribute('transform',`scale(${sz*2/20},${sz*1.8/18})`);
    p.setAttribute('fill', pick(COLORS));
    p.setAttribute('opacity', String(rnd(0.78,1)));
    g.appendChild(p); group.appendChild(g);
  }
}

/*
  Devuelve la lista de ramas para poblar de hojas.
  ox/oy: offset de origen (para escena 4 cuyo viewBox es distinto).
  Valores de n moderados → árbol frondoso pero no saturado.
*/
function makeBranches(ox=0, oy=0){
  const p=(x,y)=>({x:x+ox,y:y+oy});
  return [
    // ── Nivel 1 izq ──
    {pts:[p(207,585),p(175,558),p(138,535),p(58,492)],  n:12,szMin:8,szMax:19,sp:24,side:0},
    {pts:[p(58,492), p(40,474), p(22,458), p(8,444)],   n:7, szMin:7,szMax:15,sp:18,side:-1},
    {pts:[p(58,492), p(68,474), p(82,459), p(97,448)],  n:7, szMin:7,szMax:15,sp:18,side:1},
    // ── Nivel 1 der ──
    {pts:[p(211,573),p(242,552),p(278,534),p(354,487)], n:12,szMin:8,szMax:19,sp:24,side:0},
    {pts:[p(354,487),p(369,470),p(384,455),p(400,442)], n:7, szMin:7,szMax:15,sp:18,side:1},
    {pts:[p(354,487),p(341,469),p(326,455),p(312,444)], n:7, szMin:7,szMax:15,sp:18,side:-1},
    // ── Nivel 2 izq ──
    {pts:[p(205,497),p(178,474),p(148,455),p(52,409)],  n:10,szMin:7,szMax:17,sp:22,side:0},
    {pts:[p(52,409), p(36,390), p(18,374), p(2,359)],   n:6, szMin:6,szMax:13,sp:16,side:-1},
    {pts:[p(52,409), p(63,391), p(78,376), p(95,366)],  n:6, szMin:6,szMax:13,sp:16,side:1},
    // ── Nivel 2 der ──
    {pts:[p(209,486),p(232,465),p(258,448),p(348,403)], n:10,szMin:7,szMax:17,sp:22,side:0},
    {pts:[p(348,403),p(362,385),p(378,370),p(396,355)], n:6, szMin:6,szMax:13,sp:16,side:1},
    {pts:[p(348,403),p(336,386),p(320,371),p(302,361)], n:6, szMin:6,szMax:13,sp:16,side:-1},
    // ── Nivel 3 izq ──
    {pts:[p(202,413),p(178,388),p(150,368),p(50,319)],  n:9, szMin:6,szMax:15,sp:20,side:0},
    {pts:[p(50,319), p(34,300), p(16,283), p(2,268)],   n:5, szMin:5,szMax:12,sp:14,side:-1},
    {pts:[p(50,319), p(62,301), p(78,285), p(97,276)],  n:5, szMin:5,szMax:12,sp:14,side:1},
    // ── Nivel 3 der ──
    {pts:[p(207,402),p(229,380),p(254,360),p(343,309)], n:9, szMin:6,szMax:15,sp:20,side:0},
    {pts:[p(343,309),p(357,292),p(372,276),p(390,261)], n:5, szMin:5,szMax:12,sp:14,side:1},
    {pts:[p(343,309),p(330,292),p(314,277),p(296,267)], n:5, szMin:5,szMax:12,sp:14,side:-1},
    // ── Centro vertical ──
    {pts:[p(203,355),p(200,330),p(197,305),p(191,208)], n:9, szMin:6,szMax:16,sp:18,side:0},
    // ── Cima ──
    {pts:[p(191,208),p(182,180),p(172,152),p(159,86)],  n:10,szMin:6,szMax:16,sp:20,side:0},
    {pts:[p(191,208),p(202,190),p(215,172),p(225,156)], n:5, szMin:5,szMax:12,sp:14,side:1},
    {pts:[p(191,208),p(178,190),p(164,172),p(154,156)], n:5, szMin:5,szMax:12,sp:14,side:-1},
    {pts:[p(159,86), p(153,68), p(148,50), p(146,32)],  n:7, szMin:5,szMax:13,sp:14,side:0},
    {pts:[p(159,86), p(167,69), p(177,52), p(185,36)],  n:4, szMin:4,szMax:10,sp:11,side:1},
    {pts:[p(159,86), p(150,69), p(139,52), p(129,36)],  n:4, szMin:4,szMax:10,sp:11,side:-1},
    // ── Puntas extremas ──
    {pts:[p(8,444),  p(-2,430)],  n:4,szMin:5,szMax:11,sp:11,side:0},
    {pts:[p(97,448), p(108,435)], n:4,szMin:5,szMax:11,sp:11,side:0},
    {pts:[p(400,442),p(412,429)], n:4,szMin:5,szMax:11,sp:11,side:0},
    {pts:[p(312,444),p(300,431)], n:4,szMin:5,szMax:11,sp:11,side:0},
    {pts:[p(2,359),  p(-8,344)],  n:3,szMin:4,szMax:10,sp:10,side:0},
    {pts:[p(95,366), p(106,353)], n:3,szMin:4,szMax:10,sp:10,side:0},
  ];
}

/*
  Construye las hojas en el grupo SVG indicado.
  ox/oy permiten ajustar coordenadas para el árbol de escena 4
  (viewBox 320×720 vs 420×730 del árbol principal).
*/
function buildLeaves(groupId, ox=0, oy=0){
  const g = el(groupId);
  g.innerHTML = '';
  makeBranches(ox, oy).forEach(b =>
    plantLeaves(g, b.pts, b.n, b.szMin, b.szMax, b.sp, b.side)
  );
}

// ═══════════════════════════════════════════
//  HOJAS CAYENDO (funciona en cualquier escena)
// ═══════════════════════════════════════════

let fallIv = null;

function spawnLeaf(sourceEl){
  if(!sourceEl) return;
  const r = sourceEl.getBoundingClientRect();
  if(r.width===0) return;

  const sz    = rnd(11,25);
  const color = pick(COLORS);
  const ox    = r.left + r.width*0.05  + Math.random()*r.width*0.85;
  const oy    = r.top  + r.height*0.03 + Math.random()*r.height*0.50;
  const dy    = (window.innerHeight - oy) + 80;
  const dx    = (Math.random()-0.5)*190;
  const dr    = (Math.random()-0.5)*700;
  const dur   = rnd(2.5,5.5);

  const svg = document.createElementNS(SVGNS,'svg');
  svg.setAttribute('viewBox','-1 -1 22 20');
  svg.setAttribute('width',sz);
  svg.setAttribute('height',sz*0.88);
  svg.innerHTML=`<path d="${HEART}" fill="${color}" opacity="${rnd(0.72,1)}"/>`;
  svg.className='fl';
  svg.style.cssText=`left:${ox}px;top:${oy}px;--dx:${dx}px;--dy:${dy}px;--dr:${dr}deg;animation-duration:${dur}s;`;
  document.body.appendChild(svg);
  T.to(()=>svg.remove(), dur*1000+100);
}

function startFalling(sourceEl){
  stopFalling();
  fallIv = T.iv(()=>spawnLeaf(sourceEl), 400);
}

function stopFalling(){
  if(fallIv){ clearInterval(fallIv); fallIv=null; }
}

// ═══════════════════════════════════════════
//  CONTADOR
// ═══════════════════════════════════════════

function updateCounter(){
  const s=Math.floor(Math.max(0,Date.now()-CFG.loveDate.getTime())/1000);
  el('cs').textContent=String(s%60).padStart(2,'0');
  el('cm').textContent=String(Math.floor(s/60)%60).padStart(2,'0');
  el('ch').textContent=String(Math.floor(s/3600)%24).padStart(2,'0');
  el('cd').textContent=Math.floor(s/86400);
}
function startCounter(){ updateCounter(); T.iv(updateCounter,1000); }

// ═══════════════════════════════════════════
//  ANIMACIÓN ÁRBOL
// ═══════════════════════════════════════════

function resetTree(){
  document.querySelectorAll('#tree-svg .T, #tree-svg .B').forEach(e=>{
    const m=(e.getAttribute('style')||'').match(/stroke-dasharray:(\d+)/);
    if(m){ e.style.transition='none'; e.style.strokeDashoffset=m[1]; }
  });
  const g=el('leaves-s3');
  g.innerHTML=''; g.style.transition='none'; g.style.opacity='0';
}

async function growTree(){
  // Pre-construye hojas (invisibles todavía)
  buildLeaves('leaves-s3', 0, 0);

  // Tronco crece
  document.querySelectorAll('#tree-svg .T').forEach(e=>{
    e.style.transition='stroke-dashoffset 1.3s cubic-bezier(0.4,0,0.2,1)';
    e.style.strokeDashoffset='0';
  });
  await wait(850);

  // Ramas en oleadas
  const brs=[...document.querySelectorAll('#tree-svg .B')];
  for(let i=0;i<brs.length;i++){
    brs[i].style.transition=`stroke-dashoffset ${rnd(0.42,0.72)}s ease-out`;
    brs[i].style.strokeDashoffset='0';
    if(i%2===0) await wait(78);
  }
  await wait(200);

  // Hojas aparecen
  const lg=el('leaves-s3');
  lg.style.transition='opacity 1.5s ease-out';
  lg.style.opacity='1';
  await wait(1100);

  // ← Hojas empiezan a caer desde el árbol de escena 3
  startFalling(el('tree-wrap'));
  await wait(2400);

  // Crossfade a escena 4
  await toScene4();
}

// ═══════════════════════════════════════════
//  TRANSICIÓN S3 → S4
// ═══════════════════════════════════════════

async function toScene4(){
  // Parar caída, limpiar hojas volando
  stopFalling(); Floaters.clear();

  const s3=el('s3'), s4=el('s4');
  s4.classList.add('active'); s4.style.opacity='0';

  // Crossfade 1s
  const dur=1000, t0=performance.now();
  await new Promise(res=>{
    function tick(now){
      const p=Math.min((now-t0)/dur,1);
      const ep=p<0.5?2*p*p:-1+(4-2*p)*p;
      s3.style.opacity=String(1-ep);
      s4.style.opacity=String(ep);
      p<1?requestAnimationFrame(tick):res();
    }
    requestAnimationFrame(tick);
  });
  s3.classList.remove('active'); s3.style.opacity='';
  s4.style.opacity='';

  // Árbol escena 4
  // El viewBox de s4 es 320×720, el árbol tiene el tronco ~en x=155 vs x=200 del s3
  // Ajustamos ox=-50 para que las hojas mapeen bien sobre las ramas reales de s4
  buildLeaves('leaves-s4', -50, -10);
  await wait(60);
  el('tree-right').classList.add('in');
  el('c-name').textContent=CFG.loveName;

  // Contador
  await wait(500);
  el('counter').classList.add('in');
  startCounter();

  // Hojas caen del árbol de escena 4
  await wait(900);
  startFalling(el('tree-right'));

  // Restart
  await wait(800);
  el('restart').classList.add('in');
}

// ═══════════════════════════════════════════
//  CAÍDA DEL CORAZÓN
// ═══════════════════════════════════════════

async function dropAnim(elem, startY, endY){
  return new Promise(res=>{
    let t0=null; const dur=1500;
    function tick(ts){
      if(!t0)t0=ts;
      const p=Math.min((ts-t0)/dur,1);
      const ep=p*p*(3-2*p);
      elem.style.top=(startY+(endY-startY-50)*ep)+'px';
      elem.style.transform=`translateX(-50%) scaleX(${1-p*0.78}) scaleY(${1-p*0.65}) rotate(${Math.sin(p*Math.PI*2)*8}deg)`;
      elem.style.opacity=p>0.85?(1-(p-0.85)/0.15):1;
      p<1?requestAnimationFrame(tick):res();
    }
    requestAnimationFrame(tick);
  });
}

async function impactFX(cx,cy){
  el('drop-heart').style.opacity='0';
  const g=el('ground');
  g.style.opacity='1'; g.style.transform='scaleX(1)';
  T.to(()=>{ g.style.opacity='0'; },350);
  const cols=['#6B0000','#B02020','#E05050','#F08080'];
  for(let i=0;i<16;i++){
    const d=document.createElement('div');
    const ang=(Math.PI*2/16)*i+rnd(-0.3,0.3);
    const dist=rnd(40,78), sz=rnd(5,12);
    d.style.cssText=`position:fixed;left:${cx}px;top:${cy}px;z-index:10;
      width:${sz}px;height:${sz}px;border-radius:50%;background:${pick(cols)};
      pointer-events:none;
      transition:transform .65s cubic-bezier(.2,.8,.4,1),opacity .65s;`;
    document.body.appendChild(d);
    requestAnimationFrame(()=>{
      d.style.transform=`translate(${Math.cos(ang)*dist}px,${Math.sin(ang)*dist}px) scale(0)`;
      d.style.opacity='0';
    });
    T.to(()=>d.remove(),800);
  }
  await wait(220);
}

async function startFall(){
  if(!el('s1').classList.contains('active')) return;
  el('heart-btn').style.animation='none';
  el('heart-btn').style.transform='scale(0.86)';
  await wait(120);

  setScene('s2');

  const dh=el('drop-heart'), vh=window.innerHeight, gY=vh*0.72;
  dh.style.cssText=`position:absolute;left:50%;top:${vh*0.3}px;
    transform:translateX(-50%);width:clamp(70px,20vw,100px);`;
  await wait(60);
  await dropAnim(dh, vh*0.3, gY);
  await impactFX(window.innerWidth/2, gY);
  await wait(260);

  setScene('s3');
  await wait(60);
  await growTree();
}

/* Muestra solo la escena indicada */
function setScene(id){
  ['s1','s2','s3','s4'].forEach(s=>{
    const e=el(s);
    e.classList.toggle('active',s===id);
    e.style.opacity='';
  });
}

// ═══════════════════════════════════════════
//  APP
// ═══════════════════════════════════════════

const App = {
  init(){
    T.clear(); Floaters.clear(); stopFalling();
    resetTree();
    el('tree-right').classList.remove('in');
    el('counter').classList.remove('in');
    el('restart').classList.remove('in');
    el('leaves-s4').innerHTML='';
    el('heart-btn').style.animation='beat 1.5s ease-in-out infinite';
    el('heart-btn').style.transform='';
    setScene('s1');
  }
};

el('heart-btn').addEventListener('click',  startFall);
el('heart-btn').addEventListener('touchend',e=>{e.preventDefault();startFall();});

App.init();
</script>
</body>
</html>
